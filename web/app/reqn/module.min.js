define(function(){"use strict";try{var module=cenozoApp.module("reqn",true)}catch(err){console.warn(err);return}angular.extend(module,{identifier:{column:"identifier"},name:{singular:"requisition",plural:"requisitions",possessive:"requisition's"},columnList:{identifier:{title:"Identifier"},reqn_type:{column:"reqn_type.name",title:"Type"},user_full_name:{title:"Owner",isIncluded:function($state,model){return!model.isApplicant()}},graduate_full_name:{title:"Trainee"},deadline:{column:"deadline.name",title:"Deadline"},amendment_version:{title:"Version"},status:{column:"stage_type.status",title:"Status",isIncluded:function($state,model){return model.isApplicant()}},state:{title:"On Hold",type:"string",isIncluded:function($state,model){return!model.isApplicant()},help:"The reason the requisition is on hold (empty if the requisition hasn't been held up)"},state_days:{title:"Days On Hold",type:"number",isIncluded:function($state,model){return!model.isApplicant()},help:"The number of days since the requisition was put on hold (empty if the requisition hasn't been held up)"},stage_type:{column:"stage_type.name",title:"Stage",type:"string",isIncluded:function($state,model){return!model.isApplicant()&&!model.isReviewer()}},reqn_version_id:{column:"reqn_version.id",type:"hidden"}},defaultOrder:{column:"identifier",reverse:false}});module.addInputGroup("",{identifier:{title:"Identifier",type:"string",constant:true,exclude:"add"},reqn_type_id:{title:"Requisition Type",type:"enum",constant:"view",exclude:true},deadline_id:{title:"Deadline",type:"enum",constant:true,exclude:true},user_id:{title:"Owner",type:"lookup-typeahead",typeahead:{table:"user",select:'CONCAT( user.first_name, " ", user.last_name, " (", user.name, ")" )',where:["user.first_name","user.last_name","user.name"]},constant:"view"},graduate_id:{title:"Trainee",type:"enum",constant:true,exclude:"add"},language_id:{title:"Language",type:"enum",constant:true,exclude:true},stage_type:{title:"Current Stage",column:"stage_type.name",type:"string",constant:true,exclude:true},state:{title:"State",type:"enum",constant:true,exclude:true},state_date:{title:"State Set On",type:"date",constant:true,exclude:true},data_expiry_date:{title:"Data Expiry Date",type:"date",constant:true,exclude:true},title:{column:"reqn_version.title",title:"Title",type:"string",constant:true,exclude:true},lay_summary:{column:"reqn_version.lay_summary",title:"Lay Summary",type:"text",constant:true,exclude:true},instruction_filename:{column:"instruction_filename",title:"Additional Documentation",type:"file",constant:true,exclude:true},suggested_revisions:{title:"Suggested Revisions",type:"boolean",exclude:true},note:{title:"Administrative Note",type:"text",exclude:true},current_reqn_version_id:{column:"reqn_version.id",type:"string",exclude:true},amendment:{column:"reqn_version.amendment",type:"string",exclude:true},funding_filename:{column:"reqn_version.funding_filename",type:"string",exclude:true},ethics_filename:{column:"reqn_version.ethics_filename",type:"string",exclude:true},has_agreements:{type:"boolean",exclude:true},data_directory:{type:"string",exclude:true},phase:{column:"stage_type.phase",type:"string",exclude:true},status:{column:"stage_type.status",type:"string",exclude:true},lang:{type:"string",column:"language.code",exclude:true},deadline:{type:"date",column:"deadline.date",exclude:true}});module.addInputGroup("Deferral Notes",{deferral_note_amendment:{title:"Amendment",type:"text",exclude:true},deferral_note_1a:{title:"Part1: A1",type:"text",exclude:"add"},deferral_note_1b:{title:"Part1: A2",type:"text",exclude:"add"},deferral_note_1c:{title:"Part1: A3",type:"text",exclude:"add"},deferral_note_1d:{title:"Part1: A4",type:"text",exclude:"add"},deferral_note_1e:{title:"Part1: A5",type:"text",exclude:"add"},deferral_note_1f:{title:"Part1: A6",type:"text",exclude:"add"},deferral_note_2a:{title:"Part2: Questionnaires",type:"text",exclude:"add"},deferral_note_2b:{title:"Part2: Physical Assessment",type:"text",exclude:"add"},deferral_note_2c:{title:"Part2: Biomarkers",type:"text",exclude:"add"},deferral_note_2d:{title:"Part2: Genomics",type:"text",exclude:"add"},deferral_note_2e:{title:"Part2: Linked Data",type:"text",exclude:"add"}});module.addExtraOperation("view",{title:"View Form",operation:function($state,model){$state.go("reqn_version.view",{identifier:model.viewModel.record.current_reqn_version_id})}});module.addExtraOperation("view",{title:"Reset Study Data",isIncluded:function($state,model){return model.viewModel.canResetData()},operation:function($state,model){model.viewModel.resetData()}});module.addExtraOperation("view",{title:"Defer to Applicant",classes:"btn-warning",isIncluded:function($state,model){return model.viewModel.show("defer")},isDisabled:function($state,model){return!model.viewModel.enabled("defer")},operation:function($state,model){model.viewModel.defer()}});module.addExtraOperation("view",{title:"Abandon",classes:"btn-danger",isIncluded:function($state,model){return model.viewModel.show("abandon")},isDisabled:function($state,model){return!model.viewModel.enabled("abandon")},operation:function($state,model){model.viewModel.abandon()}});module.addExtraOperation("view",{title:"De-activate",classes:"btn-danger",isIncluded:function($state,model){return model.viewModel.show("deactivate")},isDisabled:function($state,model){return!model.viewModel.enabled("deactivate")},operation:function($state,model){model.viewModel.deactivate()}});module.addExtraOperation("view",{title:"Re-activate",classes:"btn-warning",isIncluded:function($state,model){return model.viewModel.show("reactivate")},isDisabled:function($state,model){return!model.viewModel.enabled("reactivate")},operation:function($state,model){model.viewModel.reactivate()}});module.addExtraOperation("view",{title:"Recreate",classes:"btn-danger",isIncluded:function($state,model){return model.viewModel.show("recreate")},isDisabled:function($state,model){return!model.viewModel.enabled("recreate")},operation:function($state,model){model.viewModel.recreate()}});module.addExtraOperation("view",{title:"Proceed",classes:"btn-success",isIncluded:function($state,model){return model.viewModel.show("proceed")},isDisabled:function($state,model){return!model.viewModel.enabled("proceed")},operation:function($state,model){model.viewModel.proceed()}});module.addExtraOperationGroup("view",{title:"Proceed...",isIncluded:function($state,model){return model.viewModel.show("amendment proceed")},isDisabled:function($state,model){return!model.viewModel.enabled("proceed")},classes:"btn-success",operations:[{title:"To SAC Review",operation:function($state,model){model.viewModel.proceed("SAC Review")},isIncluded:function($state,model){return model.viewModel.show("amendment sac review")}},{title:"To DSAC Review",operation:function($state,model){model.viewModel.proceed("DSAC Review")},isIncluded:function($state,model){return model.viewModel.show("amendment dsac review")}},{title:"To Decision Made",operation:function($state,model){model.viewModel.proceed("Decision Made")},isIncluded:function($state,model){return model.viewModel.show("amendment decision made")}},{title:"To Agreement",operation:function($state,model){model.viewModel.proceed("Agreement")},isIncluded:function($state,model){return model.viewModel.show("amendment agreement")}},{title:"To Data Release",operation:function($state,model){model.viewModel.proceed("Data Release")},isIncluded:function($state,model){return model.viewModel.show("amendment data release")}},{title:"To Active",operation:function($state,model){model.viewModel.proceed("Active")},isIncluded:function($state,model){return model.viewModel.show("amendment active")}}]});module.addExtraOperation("view",{title:"Reject",classes:"btn-danger",isIncluded:function($state,model){return model.viewModel.show("reject")},isDisabled:function($state,model){return!model.viewModel.enabled("reject")},operation:function($state,model){model.viewModel.reject()}});module.addExtraOperationGroup("view",{title:"Download",operations:[{title:"Application",operation:function($state,model){model.viewModel.downloadApplication()}},{title:"Data Checklist",operation:function($state,model){model.viewModel.downloadChecklist()}},{title:"Application + Data Checklist",operation:function($state,model){model.viewModel.downloadApplicationAndChecklist()}},{title:"Funding Letter",operation:function($state,model){model.viewModel.downloadFundingLetter()},isDisabled:function($state,model){return!model.viewModel.record.funding_filename}},{title:"Ethics Letter",operation:function($state,model){model.viewModel.downloadEthicsLetter()},isDisabled:function($state,model){return!model.viewModel.record.ethics_filename}},{title:"Agreement Letters",operation:function($state,model){model.viewModel.downloadAgreementLetters()},isDisabled:function($state,model){return!model.viewModel.record.has_agreements}},{title:"Notices",operation:function($state,model){model.viewModel.displayDecisionNotice()}},{title:"Reviews",operation:function($state,model){model.viewModel.downloadReviews()}},{title:"Final Report",operation:function($state,model){model.viewModel.downloadFinalReport()},isIncluded:function($state,model){return["Report Required","Complete"].includes(model.viewModel.record.stage_type)}},{title:"Study Data",operation:function($state,model){model.viewModel.viewData()},isIncluded:function($state,model){return model.viewModel.canViewData()}}]});cenozo.providers.directive("cnReqnDeferralNote",function(){return{templateUrl:module.getFileUrl("deferral-note.tpl.html"),restrict:"E",scope:{note:"@"},controller:["$scope",function($scope){$scope.directive="cnReqnDeferralNote"}]}});cenozo.providers.directive("cnReqnAdd",["CnReqnModelFactory",function(CnReqnModelFactory){return{templateUrl:module.getFileUrl("add.tpl.html"),restrict:"E",scope:{model:"=?"},controller:function($scope){if(angular.isUndefined($scope.model))$scope.model=CnReqnModelFactory.root}}}]);cenozo.providers.directive("cnReqnList",["CnReqnModelFactory",function(CnReqnModelFactory){return{templateUrl:module.getFileUrl("list.tpl.html"),restrict:"E",scope:{model:"=?"},controller:function($scope){if(angular.isUndefined($scope.model))$scope.model=CnReqnModelFactory.root}}}]);cenozo.providers.directive("cnReqnView",["CnReqnModelFactory","CnSession",function(CnReqnModelFactory,CnSession){return{templateUrl:module.getFileUrl("view.tpl.html"),restrict:"E",scope:{model:"=?"},controller:function($scope){if(angular.isUndefined($scope.model))$scope.model=CnReqnModelFactory.root;if(3>CnSession.role.tier){$scope.$on("cnRecordView linked",function(event,data){var index=data.dataArray.findIndexByProperty("title","Decision and Deferral Notes");if(null!=index)data.dataArray.splice(index,1)})}}}}]);cenozo.providers.factory("CnReqnAddFactory",["CnBaseAddFactory",function(CnBaseAddFactory){var object=function(parentModel){CnBaseAddFactory.construct(this,parentModel)};return{instance:function(parentModel){return new object(parentModel)}}}]);cenozo.providers.factory("CnReqnListFactory",["CnBaseListFactory",function(CnBaseListFactory){var object=function(parentModel){CnBaseListFactory.construct(this,parentModel)};return{instance:function(parentModel){return new object(parentModel)}}}]);cenozo.providers.factory("CnReqnViewFactory",["CnBaseViewFactory","CnReqnHelper","CnSession","CnHttpFactory","CnModalMessageFactory","CnModalConfirmFactory","CnModalNoticeListFactory","$window","$state",function(CnBaseViewFactory,CnReqnHelper,CnSession,CnHttpFactory,CnModalMessageFactory,CnModalConfirmFactory,CnModalNoticeListFactory,$window,$state){var object=function(parentModel,root){var self=this;CnBaseViewFactory.construct(this,parentModel,root);this.deferred.promise.then(function(){if(angular.isDefined(self.stageModel))self.stageModel.listModel.heading="Stage History"});this.configureFileInput("instruction_filename");angular.extend(this,{show:function(subject){return CnReqnHelper.showAction(subject,this.record)},abandon:function(){return CnReqnHelper.abandon(this.record.getIdentifier(),"."!=this.record.amendment,this.record.lang).then(function(response){if(response){self.record.state="abandoned";self.record.state_date=moment().format("YYYY-MM-DD");self.updateFormattedRecord("state_date","date");if(angular.isDefined(self.notificationModel))self.notificationModel.listModel.onList(true)}})},delete:function(){return CnReqnHelper.delete(this.record.getIdentifier(),this.record.lang)},translate:function(value){return CnReqnHelper.translate("reqn",value,this.record.lang)},viewReport:function(){return CnReqnHelper.viewReport(this.record.getIdentifier())},downloadApplication:function(){return CnReqnHelper.download("application",this.record.current_reqn_version_id)},downloadChecklist:function(){return CnReqnHelper.download("checklist",this.record.current_reqn_version_id)},downloadApplicationAndChecklist:function(){return CnReqnHelper.download("application_and_checklist",this.record.current_reqn_version_id)},downloadFundingLetter:function(){return CnReqnHelper.download("funding_filename",this.record.current_reqn_version_id)},downloadEthicsLetter:function(){return CnReqnHelper.download("ethics_filename",this.record.current_reqn_version_id)},downloadAgreementLetters:function(){return CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath()+"?file=agreements",format:"zip"}).file()},downloadReviews:function(){return CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath()+"?file=reviews",format:"txt"}).file()},downloadFinalReport:function(){return CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath().replace("reqn","final_report"),format:"pdf"}).file()},resetData:function(){CnHttpFactory.instance({path:self.parentModel.getServiceResourcePath()+"?action=reset_data"}).patch().then(function(response){self.onView();CnModalMessageFactory.instance({title:"Study Data Reset",message:response.data?"This "+self.parentModel.module.name.possessive+" study data has been made available and will automatically expire in "+CnSession.application.studyDataExpiry+" days.":"Warning: The "+self.parentModel.module.name.singular+" has no data to make available.",error:!response.data}).show()})},canResetData:function(){var stage_type=this.record.stage_type?this.record.stage_type:"";return"administrator"==CnSession.role.name&&("Data Release"==stage_type||"Active"==stage_type)},viewData:function(){$window.open(CnSession.application.studyDataUrl+"/"+self.record.data_directory,"studyData"+self.record.id)},canViewData:function(){var stage_type=this.record.stage_type?this.record.stage_type:"";return"administrator"==CnSession.role.name&&["Data Release","Active"].includes(stage_type)||"applicant"==CnSession.role.name&&"Active"==stage_type},onView:function(force){if("reviewer"==CnSession.role.name){CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath()+"/review",data:{modifier:{where:{column:"recommendation_type_id",operator:"=",value:null}}}}).count().then(function(response){if(0<parseInt(response.headers("Total"))){CnModalMessageFactory.instance({title:"Outstanding Review",message:"Please note: this "+self.parentModel.module.name.singular+" has an outstanding review which you must complete before it can proceed with the review process."}).show()}})}return this.$$onView(force).then(function(){var mainInputGroup=self.parentModel.module.inputGroupList.findByProperty("title","");var deferralInputGroup=self.parentModel.module.inputGroupList.findByProperty("title","Deferral Notes");mainInputGroup.inputList.deadline_id.constant=3>CnSession.role.tier||"review"!=self.record.phase;mainInputGroup.inputList.deadline_id.exclude=3>CnSession.role.tier||null==self.record.deadline_id?true:"add";mainInputGroup.inputList.reqn_type_id.constant=3<=CnSession.role.tier&&"New"==self.record.stage_type?false:"view";mainInputGroup.inputList.instruction_filename.exclude=!["active","complete"].includes(self.record.phase);mainInputGroup.inputList.data_expiry_date.exclude="active"!=self.record.phase;mainInputGroup.inputList.suggested_revisions.exclude=3>CnSession.role.tier||"Decision Made"!=self.record.stage_type||"Not Approved"==self.record.next_stage_type;deferralInputGroup.inputList.deferral_note_amendment.exclude=3>CnSession.role.tier||"."==self.record.amendment;return CnHttpFactory.instance({path:"user/"+self.record.user_id+"/graduate",data:{select:{column:["id","graduate_full_name"]},modifier:{where:{column:"user.active",operator:"=",value:true},order:"user.first_name"}}}).query().then(function success(response){self.parentModel.metadata.columnList.graduate_id.enumList=[];response.data.forEach(function(item){self.parentModel.metadata.columnList.graduate_id.enumList.push({value:item.id,name:item.graduate_full_name})})})})},onPatch:function(data){return self.$$onPatch(data).then(function(){if(angular.isDefined(data.suggested_revisions)||angular.isDefined(data.reqn_type_id))return self.onView()})},deferralNotesExist:function(){return this.record.deferral_note_1a||this.record.deferral_note_1b||this.record.deferral_note_1c||this.record.deferral_note_1d||this.record.deferral_note_1e||this.record.deferral_note_1f||this.record.deferral_note_2a||this.record.deferral_note_2b||this.record.deferral_note_2c||this.record.deferral_note_2d||this.record.deferral_note_2e},enabled:function(subject){var state=this.record.state?this.record.state:"";if(["abandon","deactivate","defer","reactivate","recreate"].includes(subject)){return true}else if(["proceed","reject"].includes(subject)){return!state&&null!=this.record.next_stage_type}else return false},proceed:function(stageType){var message="Are you sure you wish to move this "+this.parentModel.module.name.singular+' to the "'+(angular.isDefined(stageType)?stageType:this.record.next_stage_type)+'" stage?';if("administrator"==CnSession.role.name&&this.deferralNotesExist()){message+="\n\nWARNING: there are deferral notes present, you may wish to remove them before proceeding."}return CnModalConfirmFactory.instance({message:message}).show().then(function(response){if(response){var queryString="?action=next_stage";if(angular.isDefined(stageType))queryString+="&stage_type="+stageType;return CnHttpFactory.instance({path:self.parentModel.getServiceResourcePath()+queryString}).patch().then(function(){self.onView();if(angular.isDefined(self.reviewModel))self.reviewModel.listModel.onList(true);if(angular.isDefined(self.stageModel))self.stageModel.listModel.onList(true);if(angular.isDefined(self.notificationModel))self.notificationModel.listModel.onList(true)})}})},reject:function(){var message="Are you sure you wish to reject the "+this.parentModel.module.name.singular+"?";return CnModalConfirmFactory.instance({message:message}).show().then(function(response){if(response){return CnHttpFactory.instance({path:self.parentModel.getServiceResourcePath()+"?action=reject"}).patch().then(function(){self.onView();if(angular.isDefined(self.reviewModel))self.reviewModel.listModel.onList(true);if(angular.isDefined(self.stageModel))self.stageModel.listModel.onList(true);if(angular.isDefined(self.notificationModel))self.notificationModel.listModel.onList(true)})}})},defer:function(){var message="Are you sure you wish to defer to the applicant?  "+"A notification will be sent indicating that an action is required by the applicant.";if(!this.deferralNotesExist()){message+="\n\nWARNING: there are currently no deferral notes to instruct the applicant why "+"their attention is required."}return CnModalConfirmFactory.instance({message:message}).show().then(function(response){if(response){return CnHttpFactory.instance({path:self.parentModel.getServiceResourcePath()+"?action=defer"}).patch().then(function(){self.record.state="deferred";self.record.state_date=moment().format("YYYY-MM-DD");self.updateFormattedRecord("state_date","date");if(angular.isDefined(self.reqnVersionModel))self.reqnVersionModel.listModel.onList(true);if(angular.isDefined(self.notificationModel))self.notificationModel.listModel.onList(true)})}})},deactivate:function(){return CnReqnHelper.deactivate(this.record.getIdentifier(),"."!=this.record.amendment,this.record.lang).then(function(response){if(response){self.record.state="inactive";self.record.state_date=moment().format("YYYY-MM-DD");self.updateFormattedRecord("state_date","date");if(angular.isDefined(self.notificationModel))self.notificationModel.listModel.onList(true)}})},deactivate:function(){return CnModalConfirmFactory.instance({message:"Are you sure you wish to de-activate the "+this.parentModel.module.name.singular+"?"+"\n\nThe applicant will no longer be able to edit or submit the "+this.parentModel.module.name.singular+"."}).show().then(function(response){if(response){return CnHttpFactory.instance({path:self.parentModel.getServiceResourcePath()+"?action=deactivate"}).patch().then(function(){self.record.state="inactive";self.record.state_date=moment().format("YYYY-MM-DD");self.updateFormattedRecord("state_date","date");if(angular.isDefined(self.notificationModel))self.notificationModel.listModel.onList(true)})}})},reactivate:function(){return CnModalConfirmFactory.instance({message:"Are you sure you wish to re-activate the "+this.parentModel.module.name.singular+"?"+"\n\nThe applicant will be notified that it has been re-activated and they will be able to re-submit for review."}).show().then(function(response){if(response){return CnHttpFactory.instance({path:self.parentModel.getServiceResourcePath()+"?action=reactivate"}).patch().then(function(){self.record.state="abandoned"==self.record.state?"deferred":"";self.record.state_date="abandoned"==self.record.state?moment().format("YYYY-MM-DD"):null;self.updateFormattedRecord("state_date","date");if(angular.isDefined(self.notificationModel))self.notificationModel.listModel.onList(true)})}})},recreate:function(){return CnModalConfirmFactory.instance({message:"Are you sure you wish to recreate the "+this.parentModel.module.name.singular+"?"+"\n\nA new "+this.parentModel.module.name.singular+" will be created using all of the details "+"provided in this "+this.parentModel.module.name.singular+"."}).show().then(function(response){if(response){return CnHttpFactory.instance({path:self.parentModel.getServiceCollectionPath()+"?clone="+self.record.identifier}).post().then(function(response){return $state.go("reqn.view",{identifier:response.data})})}})},displayDecisionNotice:function(){var noticeList=[];return CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath()+"/notice",data:{modifier:{order:{datetime:true}}}}).query().then(function(response){CnModalNoticeListFactory.instance({title:"Notice List",closeText:self.translate("misc.close"),noticeList:response.data}).printMessage()})}})};return{instance:function(parentModel,root){return new object(parentModel,root)}}}]);cenozo.providers.factory("CnReqnModelFactory",["CnReqnHelper","CnBaseModelFactory","CnReqnAddFactory","CnReqnListFactory","CnReqnViewFactory","CnHttpFactory","CnSession","$state","$q",function(CnReqnHelper,CnBaseModelFactory,CnReqnAddFactory,CnReqnListFactory,CnReqnViewFactory,CnHttpFactory,CnSession,$state,$q){var object=function(root){var self=this;CnBaseModelFactory.construct(this,module);this.addModel=CnReqnAddFactory.instance(this);this.listModel=CnReqnListFactory.instance(this);this.viewModel=CnReqnViewFactory.instance(this,root);this.getServiceCollectionPath=function(){return this.$$getServiceCollectionPath("root"==this.getSubjectFromState())};this.isApplicant=function(){return"applicant"==CnSession.role.name};this.isAdministrator=function(){return"administrator"==CnSession.role.name};this.isReviewer=function(){return"reviewer"==CnSession.role.name};var mainInputGroup=module.inputGroupList.findByProperty("title","");if(["administrator","sac"].includes(CnSession.role.name)){mainInputGroup.inputList.reqn_type_id.exclude=false;mainInputGroup.inputList.language_id.exclude=false;mainInputGroup.inputList.stage_type.exclude="add";mainInputGroup.inputList.state.exclude="add";mainInputGroup.inputList.state_date.exclude="add";mainInputGroup.inputList.data_expiry_date.exclude="add";mainInputGroup.inputList.note.exclude=false;if("administrator"==CnSession.role.name){mainInputGroup.inputList.identifier.constant=false;mainInputGroup.inputList.deadline_id.constant=false;mainInputGroup.inputList.graduate_id.constant=false;mainInputGroup.inputList.language_id.constant=false;mainInputGroup.inputList.instruction_filename.constant=false}}else{mainInputGroup.inputList.title.exclude=false;mainInputGroup.inputList.lay_summary.exclude=false}this.getEditEnabled=function(){var phase=this.viewModel.record.phase?this.viewModel.record.phase:"";var state=this.viewModel.record.state?this.viewModel.record.state:"";var stage_type=this.viewModel.record.stage_type?this.viewModel.record.stage_type:"";var check=false;if("applicant"==CnSession.role.name){check="new"==phase||"deferred"==state&&"review"==phase}else if(["administrator","sac"].includes(CnSession.role.name)){check=true}return this.$$getEditEnabled()&&check};this.getDeleteEnabled=function(){return this.$$getDeleteEnabled()&&angular.isDefined(this.listModel.record)&&"new"==this.listModel.record.phase};this.transitionToAddState=function(){return"applicant"!=CnSession.role.name?this.$$transitionToAddState():CnHttpFactory.instance({path:"reqn",data:{user_id:CnSession.user.id}}).post().then(function(response){return CnHttpFactory.instance({path:"reqn/"+response.data,data:{select:{column:{table:"reqn_version",column:"id",alias:"reqn_version_id"}}}}).get().then(function(response){return $state.go("reqn_version.view",{identifier:response.data.reqn_version_id})})})};this.transitionToViewState=function(record){if(this.isApplicant())$state.go("reqn_version.view",{identifier:record.reqn_version_id});else this.$$transitionToViewState(record)};this.getServiceData=function(type,columnRestrictLists){var data=this.$$getServiceData(type,columnRestrictLists);if("root"==this.getSubjectFromState()){if(angular.isUndefined(data.modifier.where))data.modifier.where=[];if("chair"==CnSession.role.name){data.modifier.where.push({column:"stage_type.name",operator:"LIKE",value:"%DSAC%"})}else if("smt"==CnSession.role.name){data.modifier.where.push({column:"stage_type.name",operator:"LIKE",value:"%SMT%"})}}return data};this.getMetadata=function(){return self.$$getMetadata().then(function(){return $q.all([CnHttpFactory.instance({path:"reqn_type",data:{select:{column:["id","name"]},modifier:{order:"name"}}}).query().then(function success(response){self.metadata.columnList.reqn_type_id.enumList=[];response.data.forEach(function(item){self.metadata.columnList.reqn_type_id.enumList.push({value:item.id,name:item.name})})}),CnHttpFactory.instance({path:"deadline",data:{select:{column:["id","name"]},modifier:{order:"date",desc:true}}}).query().then(function success(response){self.metadata.columnList.deadline_id.enumList=[];response.data.forEach(function(item){self.metadata.columnList.deadline_id.enumList.push({value:item.id,name:item.name})})}),CnHttpFactory.instance({path:"language",data:{select:{column:["id","name"]},modifier:{where:{column:"active",operator:"=",value:true},order:"name"}}}).query().then(function success(response){self.metadata.columnList.language_id.enumList=[];response.data.forEach(function(item){self.metadata.columnList.language_id.enumList.push({value:item.id,name:item.name})})})])})}};return{root:new object(true),instance:function(){return new object(false)}}}])});
