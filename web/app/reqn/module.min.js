define(["coapplicant","reference"].reduce(function(list,name){return list.concat(cenozoApp.module(name).getRequiredFiles())},[]),function(){"use strict";try{var module=cenozoApp.module("reqn",true)}catch(err){console.warn(err);return}var coapplicantModule=cenozoApp.module("coapplicant");var referenceModule=cenozoApp.module("reference");angular.extend(module,{identifier:{column:"identifier"},name:{singular:"requisition",plural:"requisitions",possessive:"requisition's"},columnList:{identifier:{title:"Identifier"},user_full_name:{title:"Applicant"},deadline:{column:"deadline.name",title:"Deadline"},status:{column:"stage_type.status",title:"Status",isIncluded:function($state,model){return model.isApplicant()}},state:{title:"On Hold",type:"string",isIncluded:function($state,model){return!model.isApplicant()},help:"The reason the requisition is on hold (empty if the requisition hasn't been held up)"},stage_type:{column:"stage_type.name",title:"Stage",type:"string",isIncluded:function($state,model){return!model.isApplicant()}}},defaultOrder:{column:"identifier",reverse:false}});module.addInputGroup("",{identifier:{title:"Identifier",type:"string"},language_id:{title:"Language",type:"enum"},stage_type:{title:"Current Stage",column:"stage_type.name",type:"string",constant:true,exclude:true},state:{title:"State",type:"enum",constant:true,exclude:true},phase:{column:"stage_type.phase",type:"string",exclude:true},status:{column:"stage_type.status",type:"string",exclude:true},decision:{column:"stage_type.decision",type:"boolean",exclude:true},recommendation:{type:"string",exclude:true},stage_complete:{type:"string",exclude:true},language:{type:"string",column:"language.code",exclude:true},deadline:{type:"date",column:"deadline.date",exclude:true},applicant_name:{type:"string",exclude:true},applicant_position:{type:"string",exclude:true},applicant_affiliation:{type:"string",exclude:true},applicant_address:{type:"string",exclude:true},applicant_phone:{type:"string",exclude:true},applicant_email:{type:"string",format:"email",exclude:true},graduate_name:{type:"string",exclude:true},graduate_program:{type:"string",exclude:true},graduate_institution:{type:"string",exclude:true},graduate_address:{type:"string",exclude:true},graduate_phone:{type:"string",exclude:true},graduate_email:{type:"string",format:"email",exclude:true},start_date:{type:"date",exclude:true},duration:{type:"string",exclude:true},title:{type:"string",exclude:true},keywords:{type:"string",exclude:true},lay_summary:{type:"string",exclude:true},background:{type:"text",exclude:true},objectives:{type:"text",exclude:true},methodology:{type:"text",exclude:true},analysis:{type:"text",exclude:true},funding:{type:"enum",exclude:true},funding_agency:{type:"string",exclude:true},grant_number:{type:"string",exclude:true},ethics:{type:"boolean",exclude:true},ethics_date:{type:"date",exclude:true},ethics_filename:{type:"string",exclude:true},waiver:{type:"enum",exclude:true},qnaire:{type:"boolean",exclude:true},qnaire_comment:{type:"text",exclude:true},physical:{type:"boolean",exclude:true},physical_comment:{type:"text",exclude:true},biomarker:{type:"boolean",exclude:true},biomarker_comment:{type:"text",exclude:true}});module.addInputGroup("Decision and Deferral Notes",{decision_notice:{title:"Notice of Desision",type:"text"},deferral_note_part1_a1:{title:"Part1 A1",type:"text"},deferral_note_part1_a2:{title:"Part1 A2",type:"text"},deferral_note_part1_a3:{title:"Part1 A3",type:"text"},deferral_note_part1_a4:{title:"Part1 A4",type:"text"},deferral_note_part1_a5:{title:"Part1 A5",type:"text"},deferral_note_part1_a6:{title:"Part1 A6",type:"text"},deferral_note_part2_a:{title:"Part2 A",type:"text"},deferral_note_part2_b:{title:"Part2 B",type:"text"},deferral_note_part2_c:{title:"Part2 C",type:"text"}});module.addExtraOperation("view",{title:"View Form",operation:function($state,model){$state.go("reqn.form",{identifier:model.viewModel.record.getIdentifier()})}});module.addExtraOperation("view",{title:"Defer to Applicant",classes:"btn-warning",isIncluded:function($state,model){return model.viewModel.show("defer")},isDisabled:function($state,model){return!model.viewModel.enabled("defer")},operation:function($state,model){model.viewModel.defer()}});module.addExtraOperation("view",{title:"Abandon",classes:"btn-warning",isIncluded:function($state,model){return model.viewModel.show("abandon")},isDisabled:function($state,model){return!model.viewModel.enabled("abandon")},operation:function($state,model){model.viewModel.abandon()}});module.addExtraOperation("view",{title:"Re-activate",classes:"btn-warning",isIncluded:function($state,model){return model.viewModel.show("reactivate")},isDisabled:function($state,model){return!model.viewModel.enabled("reactivate")},operation:function($state,model){model.viewModel.reactivate()}});module.addExtraOperation("view",{title:"Proceed",classes:"btn-success",isIncluded:function($state,model){return model.viewModel.show("proceed")},isDisabled:function($state,model){return!model.viewModel.enabled("proceed")},operation:function($state,model){model.viewModel.proceed()}});module.addExtraOperationGroup("view",{title:"Apply Decision",classes:"btn-success",isIncluded:function($state,model){return model.viewModel.show("decide")},isDisabled:function($state,model){return!model.viewModel.enabled("decide")},operations:[{title:"Approved",isIncluded:function($state,model){return model.viewModel.show("approved")},isDisabled:function($state,model){return!model.viewModel.enabled("approved")},operation:function($state,model){model.viewModel.decide(1)}},{title:"Proceed",isIncluded:function($state,model){return model.viewModel.show("apply proceed")},isDisabled:function($state,model){return!model.viewModel.enabled("apply proceed")},operation:function($state,model){model.viewModel.proceed()}},{title:"Send to SMT",isIncluded:function($state,model){return model.viewModel.show("send to SMT")},isDisabled:function($state,model){return!model.viewModel.enabled("send to SMT")},operation:function($state,model){model.viewModel.proceed(true)}},{title:"Reject",isIncluded:function($state,model){return model.viewModel.show("reject")},isDisabled:function($state,model){return!model.viewModel.enabled("reject")},operation:function($state,model){model.viewModel.decide(0)}}]});module.addExtraOperation("view",{title:"Download",operation:function($state,model){model.viewModel.downloadForm()}});cenozo.providers.directive("cnReqnDeferralNote",function(){return{templateUrl:module.getFileUrl("deferral-note.tpl.html"),restrict:"E",scope:{note:"@"},controller:["$scope",function($scope){$scope.directive="cnReqnDeferralNote"}]}});cenozo.providers.directive("cnReqnForm",["CnReqnModelFactory","cnRecordViewDirective","CnSession","$q",function(CnReqnModelFactory,cnRecordViewDirective,CnSession,$q){var cnRecordView=cnRecordViewDirective[0];return{templateUrl:module.getFileUrl("form.tpl.html"),restrict:"E",scope:{model:"=?"},link:function(scope,element,attrs){cnRecordView.link(scope,element,attrs);scope.isAddingCoapplicant=false;scope.isDeletingCoapplicant=[];scope.isAddingReference=false;scope.isDeletingReference=[];scope.model.viewModel.afterView(function(){CnSession.setBreadcrumbTrail([{title:scope.model.module.name.plural.ucWords(),go:function(){scope.model.transitionToListState()}},{title:scope.model.viewModel.record.identifier,go:function(){scope.model.transitionToViewState(scope.model.viewModel.record)}}]);scope.model.viewModel.displayDecisionNotice()});CnSession.promise.then(function(){scope.startDateDelay=CnSession.application.startDateDelay});scope.$watch("model.viewModel.record.start_date",function(date){var element=cenozo.getFormElement("start_date");if(element){if(null!=date&&element.$error.required)element.$error.required=false;if(element.$error.custom)element.$error.custom=false;cenozo.updateFormElement(element,true)}});scope.$watch("model.viewModel.record.lay_summary",function(text){scope.model.viewModel.charCount.lay_summary=text?text.length:0});scope.$watch("model.viewModel.record.background",function(text){scope.model.viewModel.wordCount.background=text?text.split(" ").length:0});scope.$watch("model.viewModel.record.objectives",function(text){scope.model.viewModel.wordCount.objectives=text?text.split(" ").length:0});scope.$watch("model.viewModel.record.methodology",function(text){scope.model.viewModel.wordCount.methodology=text?text.split(" ").length:0});scope.$watch("model.viewModel.record.analysis",function(text){scope.model.viewModel.wordCount.analysis=text?text.split(" ").length:0})},controller:function($scope){if(angular.isUndefined($scope.model))$scope.model=CnReqnModelFactory.root;cnRecordView.controller[1]($scope);var coapplicantAddModel=$scope.model.viewModel.coapplicantModel.addModel;$scope.coapplicantRecord={};coapplicantAddModel.onNew($scope.coapplicantRecord);$scope.getHeading=function(){var status=$scope.model.viewModel.record[$scope.model.isApplicant()?"status":"stage_type"];if("deferred"==$scope.model.viewModel.record.state){status=$scope.model.isApplicant()?"Action Required":"Deferred to Applicant"}else if($scope.model.viewModel.record.state){status=$scope.model.viewModel.record.state.ucWords()}return $scope.t("heading")+" - "+$scope.model.viewModel.record.identifier+" ("+status+")"};$scope.addCoapplicant=function(){if($scope.model.viewModel.coapplicantModel.getAddEnabled()){var form=cenozo.getScopeByQuerySelector("#part1a2Form").part1a2Form;var valid=true;for(var property in $scope.model.viewModel.coapplicantModel.module.inputGroupList[0].inputList){var currentElement=cenozo.getFormElement(property);currentElement.$error.conflict=false;cenozo.updateFormElement(currentElement);if(currentElement.$invalid){valid=false;break}}if(!valid){cenozo.forEachFormElement("part1a2Form",function(element){element.$dirty=true})}else{$scope.isAddingCoapplicant=true;coapplicantAddModel.onAdd($scope.coapplicantRecord).then(function(response){form.$setPristine();return $q.all([coapplicantAddModel.onNew($scope.coapplicantRecord),$scope.model.viewModel.getCoapplicantList()])}).finally(function(){$scope.isAddingCoapplicant=false})}}};$scope.removeCoapplicant=function(id){if($scope.model.viewModel.coapplicantModel.getDeleteEnabled()){if(0>$scope.isDeletingCoapplicant.indexOf(id))$scope.isDeletingCoapplicant.push(id);var index=$scope.isDeletingCoapplicant.indexOf(id);$scope.model.viewModel.removeCoapplicant(id).finally(function(){if(0<=index)$scope.isDeletingCoapplicant.splice(index,1)})}};var referenceAddModel=$scope.model.viewModel.referenceModel.addModel;$scope.referenceRecord={};referenceAddModel.onNew($scope.referenceRecord);$scope.addReference=function(){if($scope.model.viewModel.referenceModel.getAddEnabled()){var form=cenozo.getScopeByQuerySelector("#part1a4Form").part1a4Form;if(!form.$valid){cenozo.forEachFormElement("part1a4Form",function(element){element.$dirty=true})}else{$scope.isAddingReference=true;referenceAddModel.onAdd($scope.referenceRecord).then(function(response){form.$setPristine();return $q.all([referenceAddModel.onNew($scope.referenceRecord),$scope.model.viewModel.getReferenceList()])}).finally(function(){$scope.isAddingReference=false})}}};$scope.removeReference=function(id){if($scope.model.viewModel.referenceModel.getDeleteEnabled()){if(0>$scope.isDeletingReference.indexOf(id))$scope.isDeletingReference.push(id);var index=$scope.isDeletingReference.indexOf(id);$scope.model.viewModel.removeReference(id).finally(function(){if(0<=index)$scope.isDeletingReference.splice(index,1)})}};$scope.setReferenceRank=function(id,rank){$scope.model.viewModel.setReferenceRank(id,rank)};$scope.check=function(property){var element=cenozo.getFormElement(property);if(element){if(null!=coapplicantModule.getInput(property)){element.$error.format=!$scope.model.viewModel.coapplicantModel.testFormat(property,$scope.coapplicantRecord[property])}else if(null!=referenceModule.getInput(property)){element.$error.format=!$scope.model.viewModel.referenceModel.testFormat(property,$scope.referenceRecord[property])}cenozo.updateFormElement(element,true)}};$scope.t=function(value){return $scope.model.viewModel.translate(value)}}}}]);cenozo.providers.directive("cnReqnView",["CnReqnModelFactory",function(CnReqnModelFactory){return{templateUrl:module.getFileUrl("view.tpl.html"),restrict:"E",scope:{model:"=?"},controller:function($scope){if(angular.isUndefined($scope.model))$scope.model=CnReqnModelFactory.root}}}]);cenozo.providers.directive("cnReqnList",["CnReqnModelFactory",function(CnReqnModelFactory){return{templateUrl:module.getFileUrl("list.tpl.html"),restrict:"E",scope:{model:"=?"},controller:function($scope){if(angular.isUndefined($scope.model))$scope.model=CnReqnModelFactory.root}}}]);cenozo.providers.factory("CnReqnListFactory",["CnBaseListFactory",function(CnBaseListFactory){var object=function(parentModel){CnBaseListFactory.construct(this,parentModel)};return{instance:function(parentModel){return new object(parentModel)}}}]);cenozo.providers.factory("CnReqnViewFactory",["CnCoapplicantModelFactory","CnReferenceModelFactory","CnBaseViewFactory","CnSession","CnHttpFactory","CnModalMessageFactory","CnModalConfirmFactory","CnModalTextFactory","$q",function(CnCoapplicantModelFactory,CnReferenceModelFactory,CnBaseViewFactory,CnSession,CnHttpFactory,CnModalMessageFactory,CnModalConfirmFactory,CnModalTextFactory,$q){var object=function(parentModel,root){var self=this;CnBaseViewFactory.construct(this,parentModel,root);this.deferred.promise.then(function(){if(angular.isDefined(self.stageModel))self.stageModel.listModel.heading="Stage History"});angular.extend(this,{onView:function(force){if("reqn"==this.parentModel.getSubjectFromState()&&"form"==this.parentModel.getActionFromState()){this.setTab(0,this.parentModel.getQueryParameter("t0"),false);this.setTab(1,this.parentModel.getQueryParameter("t1"),false);this.setTab(2,this.parentModel.getQueryParameter("t2"),false);return $q.all([this.$$onView(force).then(function(){self.minStartDate=moment(self.record.deadline).add(CnSession.application.startDateDelay,"months");return self.updateEthicsFileSize()}),this.getCoapplicantList(),this.getReferenceList(),this.getDataOptionValueList()])}return this.$$onView(force)},deferralNotesExist:function(){return this.record.deferral_note_part1_a1||this.record.deferral_note_part1_a2||this.record.deferral_note_part1_a3||this.record.deferral_note_part1_a4||this.record.deferral_note_part1_a5||this.record.deferral_note_part1_a6||this.record.deferral_note_part2_a||this.record.deferral_note_part2_b||this.record.deferral_note_part2_c},show:function(subject){var role=CnSession.role.name;var phase=this.record.phase;var state=this.record.state;var stage_type=this.record.stage_type;var decision=this.record.decision;if("submit"==subject){return"applicant"==role&&("new"==phase||"deferred"==state)}else if("view"==subject){return"applicant"!=role}else if("abandon"==subject){return 0<=["administrator","applicant"].indexOf(role)&&"deferred"==state&&"review"==phase}else if("delete"==subject){return"new"==phase}else if("defer"==subject){return"administrator"==role&&0>["abandoned","deferred"].indexOf(state)&&0<=["review","agreement"].indexOf(phase)}else if("reactivate"==subject){return"administrator"==role&&"abandoned"==state}else if("proceed"==subject){return 0<=["administrator","chair"].indexOf(role)&&!decision&&0<=["review","agreement"].indexOf(phase)}else if("decide"==subject){return decision&&("administrator"==role||"chair"==role&&"DSAC"==stage_type.substring(0,4)||"smt"==role&&"SMT Decision"==stage_type)}else{if("approved"==subject){return"DSAC Selection"!=stage_type}else if("reject"==subject){return"DSAC Review"!=stage_type}else if("send to SMT"==subject){return"DSAC Review"==stage_type}else if("apply proceed"==subject){return"DSAC Selection"==stage_type}else return false}},enabled:function(subject){var state=this.record.state;var recommendation=this.record.recommendation;var stage_type=this.record.stage_type;var stage_complete=this.record.stage_complete;if(0<=["abandon","defer","reactivate"].indexOf(subject)){return true}else if("proceed"==subject){return!state&&("DSAC Review"==stage_type||stage_complete)}else if("decide"==subject){return!state}else{if("approved"==subject){return stage_complete&&("DSAC Review"==stage_type&&"Approved"==recommendation||"SMT Decision"==stage_type&&"Not Approved"!=recommendation)}else if("send to SMT"==subject){return stage_complete&&"Approved"!=recommendation}else if("reject"==subject){return"DSAC Selection"==stage_type||stage_complete&&"Not Approved"==recommendation}else if("apply proceed"==subject){return stage_complete}else return false}},proceed:function(smt){if(angular.isUndefined(smt))smt=false;var message="Are you sure you wish to "+(smt?"send the "+this.parentModel.module.name.singular+" to the SMT for review?":"proceed to the next stage?");if(this.deferralNotesExist()){message+="\n\nWARNING: there are deferral notes present, you may wish to remove them before proceeding."}return CnModalConfirmFactory.instance({message:message}).show().then(function(response){if(response){return CnHttpFactory.instance({path:self.parentModel.getServiceResourcePath()+"?action=next_stage"}).patch().then(function(){self.onView();if(angular.isDefined(self.reviewModel))self.reviewModel.listModel.onList(true);if(angular.isDefined(self.stageModel))self.stageModel.listModel.onList(true);if(angular.isDefined(self.notificationModel))self.notificationModel.listModel.onList(true)})}})},downloadForm:function(){return CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath(),format:"pdf"}).file()},decide:function(decision){return CnModalTextFactory.instance({title:(decision?"Approve":"Reject")+" "+this.parentModel.module.name.singular.ucWords(),message:"In order to "+(decision?"approve":"reject")+" the "+this.parentModel.module.name.singular+" you must provide a message which will be included as part of the formal notice to the applicant.",minLength:1}).show().then(function(response){if(response){return CnHttpFactory.instance({path:self.parentModel.getServiceResourcePath()+"?action=decide&approve="+decision,data:{decision_notice:response}}).patch().then(function(){self.onView();if(angular.isDefined(self.reviewModel))self.reviewModel.listModel.onList(true);if(angular.isDefined(self.stageModel))self.stageModel.listModel.onList(true);if(angular.isDefined(self.notificationModel))self.notificationModel.listModel.onList(true)})}})},defer:function(){var message="Are you sure you wish to defer to the applicant?";if(!this.deferralNotesExist()){message+="\n\nWARNING: there are currently no deferral notes to instruct the applicant why "+"their attention is required."}return CnModalConfirmFactory.instance({message:message}).show().then(function(response){if(response){return CnHttpFactory.instance({path:self.parentModel.getServiceResourcePath()+"?action=defer"}).patch().then(function(){self.record.state="deferred";if(angular.isDefined(self.notificationModel))self.notificationModel.listModel.onList(true)})}})},reactivate:function(){return CnModalConfirmFactory.instance({message:"Are you sure you want to re-activate the "+this.parentModel.module.name.singular+"?"+"\n\nThe applicant will be notified that it has been re-activated and they will be able to re-submit for review."}).show().then(function(response){if(response){return CnHttpFactory.instance({path:self.parentModel.getServiceResourcePath()+"?action=reactivate"}).patch().then(function(){self.record.state="deferred";if(angular.isDefined(self.notificationModel))self.notificationModel.listModel.onList(true)})}})},coapplicantModel:CnCoapplicantModelFactory.instance(),coapplicantList:[],referenceModel:CnReferenceModelFactory.instance(),referenceList:[],dataOptionValueList:[],charCount:{lay_summary:0},wordCount:{background:0,objectives:0,methodology:0,analysis:0},uploadingEthicsFile:false,ethicsFileSize:null,minStartDate:null,translate:function(value){return cenozoApp.translate(value,this.record.language)},toggleLanguage:function(){this.record.language="en"==this.record.language?"fr":"en";return CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath(),data:{language:this.record.language}}).patch()},tab:[],tabSectionList:[["instructions",null,null],["part1","a1",null],["part1","a2",null],["part1","a3",null],["part1","a4",null],["part1","a5",null],["part1","a6",null],["part2",null,"notes"],["part2",null,"a"],["part2",null,"b"],["part2",null,"c"],["part3",null,null]],setTab:function(index,tab,transition){if(angular.isUndefined(transition))transition=true;if(!(0<=index&&index<=2))index=0;var selectedTabSection=null;this.tabSectionList.some(function(tabSection){if(tab==tabSection[index]){selectedTabSection=tabSection;return true}});tab=null!=selectedTabSection&&null!=selectedTabSection[index]?selectedTabSection[index]:0==index?"instructions":1==index?"a1":"notes";self.tab[index]=tab;self.parentModel.setQueryParameter("t"+index,tab);if(transition)this.parentModel.reloadState(false,false,"replace");angular.element("textarea[cn-elastic]").trigger("elastic")},nextSection:function(reverse){if(angular.isUndefined(reverse))reverse=false;var currentTabSectionIndex=null;this.tabSectionList.some(function(tabSection,index){if(self.tab[0]==tabSection[0]){if((null==tabSection[1]||self.tab[1]==tabSection[1])&&(null==tabSection[2]||self.tab[2]==tabSection[2])){currentTabSectionIndex=index;return true}}});if(null!=currentTabSectionIndex){var tabSection=this.tabSectionList[currentTabSectionIndex+(reverse?-1:1)];if(angular.isDefined(tabSection)){if(null!=tabSection[2])this.setTab(2,tabSection[2],false);if(null!=tabSection[1])this.setTab(1,tabSection[1],false);this.setTab(0,tabSection[0])}}},getCoapplicantList:function(){return CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath()+"/coapplicant",data:{select:{column:["id","name","position","affiliation","email","role","access"]},modifier:{order:"id",limit:1e6}}}).query().then(function(response){self.coapplicantList=response.data})},removeCoapplicant:function(id){return CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath()+"/coapplicant/"+id}).delete().then(function(){return self.getCoapplicantList()})},getReferenceList:function(){return CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath()+"/reference",data:{select:{column:["id","rank","reference"]},modifier:{order:"rank",limit:1e6}}}).query().then(function(response){self.referenceList=response.data})},setReferenceRank:function(id,rank){return CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath()+"/reference/"+id,data:{rank:rank}}).patch().then(function(){return self.getReferenceList()})},removeReference:function(id){return CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath()+"/reference/"+id}).delete().then(function(){return self.getReferenceList()})},updateEthicsFileSize:function(){return CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath()+"?letter=1"}).get().then(function(response){self.ethicsFileSize=response.data})},downloadEthicsFile:function(){return CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath()+"?letter=1",format:"unknown"}).file()},removeEthicsFile:function(){return this.onPatch({ethics_filename:null}).then(function(){return self.updateEthicsFileSize()})},uploadEthicsFile:function(){thisx.uploadingEthicsFile=true;var data=new FormData;data.append("file",this.ethicsFile);var fileDetails=data.get("file");return CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath(),data:{ethics_filename:fileDetails.name}}).patch().then(function(){self.record.ethics_filename=fileDetails.name;return CnHttpFactory.instance({path:self.parentModel.getServiceResourcePath()+"?letter=1",data:self.ethicsFile,format:"unknown"}).patch()}).then(function(){return self.updateEthicsFileSize()}).finally(function(){self.uploadingEthicsFile=false})},getDataOptionValueList:function(){self.dataOptionValueList=[];return CnHttpFactory.instance({path:"data_option",data:{select:{column:[{column:"MAX(id)",alias:"maxId",table_prefix:false}]}}}).get().then(function(response){for(var i=0;i<=response.data[0].maxId;i++)self.dataOptionValueList[i]=false}).then(function(){return CnHttpFactory.instance({path:self.parentModel.getServiceResourcePath()+"/data_option",data:{select:{column:["id"]}}}).query().then(function(response){response.data.forEach(function(dataOption){self.dataOptionValueList[dataOption.id]=true})})})},setDataOptionValue:function(dataOptionId){var add=this.dataOptionValueList[dataOptionId];var http=CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath()+"/data_option"+(add?"":"/"+dataOptionId),data:add?{add:dataOptionId}:undefined,onError:function(response){var ignoreCode=add?409:404;if(ignoreCode!=response.status){self.dataOptionValueList[dataOptionId]=!self.dataOptionValueList[dataOptionId];CnModalMessageFactory.httpError(response)}}});return add?http.post():http.delete()},submit:function(){var record=this.record;return CnModalConfirmFactory.instance({title:this.translate("misc.pleaseConfirm"),message:this.translate("misc.submitWarning")}).show().then(function(response){if(response){var requiredTabList={a1:["applicant_name","applicant_position","applicant_affiliation","applicant_address","applicant_phone","applicant_email"],a3:["start_date","duration"],a4:["title","keywords","lay_summary","background","objectives","methodology","analysis"],a5:["funding"],a6:["ethics"]};var error=null;var errorTab=null;for(var tab in requiredTabList){var firstProperty=null;requiredTabList[tab].forEach(function(property){if(null===record[property]||""===record[property]){var element=cenozo.getFormElement(property);element.$error.required=true;cenozo.updateFormElement(element,true);if(null==errorTab)errorTab=tab;if(null==error)error={title:self.translate("misc.missingFieldTitle"),message:self.translate("misc.missingFieldMessage"),error:true}}})}if(null==error){if(null!=record.lay_summary&&1e3<record.lay_summary.length){var element=cenozo.getFormElement("lay_summary");element.$error.custom=self.translate("misc.tooManyCharactersTitle");cenozo.updateFormElement(element,true);if(null==errorTab)errorTab="a4";if(null==error)error={title:self.translate("misc.tooManyCharactersTitle"),message:self.translate("misc.tooManyCharactersMessage"),error:true}}}if(null!=error){var element=cenozo.getFormElement("lay_summary");CnModalMessageFactory.instance(error).show().then(function(){self.setTab(0,"part1",false);self.setTab(1,errorTab)})}else{return CnHttpFactory.instance({path:self.parentModel.getServiceResourcePath()+"?action=submit",onError:function(response){if(409==response.status){CnModalMessageFactory.instance({title:self.translate("misc.invalidStartDateTitle"),message:self.translate("misc.invalidStartDateMessage"),error:true}).show().then(function(){var element=cenozo.getFormElement("start_date");element.$error.custom=self.translate("misc.invalidStartDateTitle");cenozo.updateFormElement(element,true);self.setTab(0,"part1",false);self.setTab(1,"a3")})}else CnModalMessageFactory.httpError(response)}}).patch().then(function(){self.transitionOnViewParent()})}}})},downloadForm:function(){return CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath(),format:"pdf"}).file()},viewRecord:function(){return this.parentModel.transitionToViewState(this.record)},abandon:function(){return CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath()+"?action=abandon"}).patch().then(function(){if("applicant"==CnSession.role.name){self.transitionOnViewParent()}else{self.record.state="abandoned";if(angular.isDefined(self.notificationModel))self.notificationModel.listModel.onList(true)}})},delete:function(){return CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath()}).delete().then(function(){self.transitionOnViewParent()})},displayDecisionNotice:function(){if("applicant"==CnSession.role.name&&this.record.decision_notice&&("Approved"==this.record.stage_type||"Not Approved"==this.record.stage_type)){CnModalMessageFactory.instance({title:this.parentModel.module.name.singular.ucWords()+" "+this.record.identifier+" "+this.record.stage_type,message:"Dear "+this.record.applicant_name+",\n\n"+"TODO: the generic header for notice of decision letters must be written\n\n"+this.record.decision_notice+"\n\n"+"TODO: the generic footer for notice of decision letters must be written"}).show()}}});this.coapplicantModel.metadata.getPromise();this.referenceModel.metadata.getPromise()};return{instance:function(parentModel,root){return new object(parentModel,root)}}}]);cenozo.providers.factory("CnReqnModelFactory",["CnBaseModelFactory","CnReqnListFactory","CnReqnViewFactory","CnHttpFactory","CnSession","$state","$transitions","$q",function(CnBaseModelFactory,CnReqnListFactory,CnReqnViewFactory,CnHttpFactory,CnSession,$state,$transitions,$q){var object=function(root){var self=this;CnBaseModelFactory.construct(this,module);this.listModel=CnReqnListFactory.instance(this);this.viewModel=CnReqnViewFactory.instance(this,root);this.getServiceCollectionPath=function(){return this.$$getServiceCollectionPath("root"==this.getSubjectFromState())};this.getServiceData=function(type,columnRestrictLists){var data=this.$$getServiceData(type,columnRestrictLists);if("root"==this.getSubjectFromState()){if(angular.isUndefined(data.modifier.where))data.modifier.where=[];if("chair"==CnSession.role.name){data.modifier.where.push({column:"stage_type.name",operator:"LIKE",value:"DSAC%"})}else if("smt"==CnSession.role.name){data.modifier.where.push({column:"stage_type.name",operator:"LIKE",value:"SMT%"})}}return data};this.inputList={};module.inputGroupList.forEach(group=>Object.assign(self.inputList,group.inputList));this.isApplicant=function(){return"applicant"==CnSession.role.name};if("applicant"!=CnSession.role.name){var mainInputGroup=module.inputGroupList.findByProperty("title","");mainInputGroup.inputList.stage_type.exclude=false;mainInputGroup.inputList.state.exclude=false}this.getEditEnabled=function(){var phase=this.viewModel.record.phase;var state=this.viewModel.record.state;return this.$$getEditEnabled()&&("applicant"==CnSession.role.name?"new"==phase||"review"==phase&&"deferred"==state:"administrator"==CnSession.role.name?"new"==phase||"review"==phase&&"abandoned"!=state:false)};this.getDeleteEnabled=function(){return this.$$getDeleteEnabled()&&angular.isDefined(this.listModel.record)&&"new"==this.listModel.record.phase};this.transitionToAddState=function(){return CnHttpFactory.instance({path:"reqn",data:{user_id:CnSession.user.id}}).post().then(function(response){return self.transitionToViewState({getIdentifier:function(){return response.data}})})};this.transitionToViewState=function(record){if(this.isApplicant())$state.go("reqn.form",{identifier:record.getIdentifier()});else this.$$transitionToViewState(record)};this.dataOptionParentList=[];this.dataOptionList=[];this.getMetadata=function(){return $q.all([self.$$getMetadata().then(function(){self.metadata.accessEnumList={en:[{value:true,name:"Yes"},{value:false,name:"No"}],fr:[{value:true,name:"Oui"},{value:false,name:"Non"}]};self.metadata.columnList.ethics.enumList={en:[{value:"",name:"(choose)"},{value:true,name:"Yes"},{value:false,name:"No"}],fr:[{value:"",name:"(choisir)"},{value:true,name:"Oui"},{value:false,name:"Non"}]};self.metadata.columnList.funding.enumList={en:self.metadata.columnList.funding.enumList,fr:angular.copy(self.metadata.columnList.funding.enumList)};self.metadata.columnList.funding.enumList.fr[0].name="oui";self.metadata.columnList.funding.enumList.fr[1].name="non";self.metadata.columnList.funding.enumList.fr[2].name="demandé";self.metadata.columnList.funding.enumList.en.unshift({value:"",name:"(choose)"});self.metadata.columnList.funding.enumList.fr.unshift({value:"",name:"(choisir)"});self.metadata.columnList.waiver.enumList.unshift({value:"",name:"none"});self.metadata.columnList.waiver.enumList={en:self.metadata.columnList.waiver.enumList,fr:angular.copy(self.metadata.columnList.waiver.enumList)};self.metadata.columnList.waiver.enumList.en[1].name="Fee Waiver for Graduate student (MSc or PhD) for thesis only";self.metadata.columnList.waiver.enumList.en[2].name="Fee Waiver for Postdoctoral Fellow (limit 1 waiver for postdoctoral studies)";self.metadata.columnList.waiver.enumList.fr[0].name="aucun";self.metadata.columnList.waiver.enumList.fr[1].name="Exonération pour un étudiant des cycles supérieurs (M. Sc. ou Ph. D.) pour la thèse seulement";self.metadata.columnList.waiver.enumList.fr[2].name="Exonération pour un boursier postdoctoral "+"(limite d’une exonération pour les études postdoctorales)";return CnHttpFactory.instance({path:"language",data:{select:{column:["id","name"]},modifier:{where:{column:"active",operator:"=",value:true},order:"name"}}}).query().then(function success(response){self.metadata.columnList.language_id.enumList=[];response.data.forEach(function(item){self.metadata.columnList.language_id.enumList.push({value:item.id,name:item.name})})})}),CnHttpFactory.instance({path:"data_option_parent",data:{select:{column:["id","name_en","name_fr","note_en","note_fr"]},modifier:{limit:1e6}}}).query().then(function(response){response.data.forEach(function(dataOptionParent){self.dataOptionParentList.push({id:null,parentId:dataOptionParent.id,name:{en:dataOptionParent.name_en,fr:dataOptionParent.name_fr},note:{en:dataOptionParent.note_en,fr:dataOptionParent.note_fr},parent:true})});return CnHttpFactory.instance({path:"data_option_subcategory",data:{select:{column:["type","name_en","name_fr","note_en","note_fr",{column:"id",alias:"catId"},{table:"data_option",column:"id",alias:"optionId"},{column:"data_option_parent_id",alias:"parentId"},{table:"data_option",column:"type",alias:"option_type"},{table:"data_option",column:"replacement_en"},{table:"data_option",column:"replacement_fr"}]},modifier:{join:[{table:"data_option",onleft:"data_option_subcategory.id",onright:"data_option.data_option_subcategory_id"}],order:["data_option_subcategory.type","data_option_subcategory.rank"],limit:1e6}}}).query().then(function(response){var currentType=null;var currentCatId=null;var currentParentId=null;response.data.forEach(function(dataOption){var type=dataOption.type;if(currentType!=type){if(angular.isUndefined(self.dataOptionList[type]))self.dataOptionList[type]=[];currentType=type}if(currentParentId!=dataOption.parentId){if(null!=dataOption.parentId){self.dataOptionList[type].push(self.dataOptionParentList.findByProperty("parentId",dataOption.parentId))}else{self.dataOptionList[type].push({id:null,parentId:null,name:{en:"",fr:""},note:{en:null,fr:null},parent:true})}currentParentId=dataOption.parentId}if(currentCatId!=dataOption.catId){self.dataOptionList[type].push({catId:dataOption.catId,parentId:dataOption.parentId,name:{en:dataOption.name_en,fr:dataOption.name_fr},note:{en:dataOption.note_en,fr:dataOption.note_fr},typeList:{},parent:false});currentCatId=dataOption.catId}self.dataOptionList[type].findByProperty("catId",dataOption.catId).typeList[dataOption.option_type]={id:dataOption.optionId,replacement:{en:dataOption.replacement_en,fr:dataOption.replacement_fr}}})})})])}};return{root:new object(true),instance:function(){return new object(false)}}}])});
