define(["production","production_type"].reduce(function(list,name){return list.concat(cenozoApp.module(name).getRequiredFiles())},[]),function(){"use strict";try{var module=cenozoApp.module("final_report",true)}catch(err){console.warn(err);return}var productionModule=cenozoApp.module("production");angular.extend(module,{identifier:{parent:{subject:"reqn",column:"reqn.identifier"}},name:{singular:"final report",plural:"final reports",possessive:"final report's"},columnList:{version:{title:"Version",type:"rank"},datetime:{title:"Date & Time",type:"datetime"}},defaultOrder:{column:"final_report.version",reverse:false}});module.addInputGroup("",{identifier:{column:"reqn.identifier",title:"Identifier",type:"string"},version:{type:"string"},current_reqn_version_id:{column:"reqn_version.id",type:"string"},trainee_user_id:{column:"reqn.trainee_user_id",type:"string"},state:{column:"reqn.state",type:"string"},stage_type:{column:"stage_type.name",type:"string"},phase:{column:"stage_type.phase",type:"string"},lang:{column:"language.code",type:"string"},activities:{type:"text"},findings:{type:"text"},outcomes:{type:"text"},thesis_title:{type:"text"},thesis_status:{type:"text"},impact:{type:"text"},opportunities:{type:"text"},dissemination:{type:"text"},waiver:{column:"reqn_version.waiver",type:"string"},deferral_note_report1:{column:"reqn.deferral_note_report1",type:"text"},deferral_note_report2:{column:"reqn.deferral_note_report2",type:"text"},deferral_note_report3:{column:"reqn.deferral_note_report3",type:"text"}});cenozo.providers.directive("cnFinalReportList",["CnFinalReportModelFactory",function(CnFinalReportModelFactory){return{templateUrl:module.getFileUrl("list.tpl.html"),restrict:"E",scope:{model:"=?"},controller:function($scope){if(angular.isUndefined($scope.model))$scope.model=CnFinalReportModelFactory.root}}}]);cenozo.providers.directive("cnFinalReportView",["CnFinalReportModelFactory","cnRecordViewDirective","CnReqnModelFactory","CnReqnHelper","CnSession","$q",function(CnFinalReportModelFactory,cnRecordViewDirective,CnReqnModelFactory,CnReqnHelper,CnSession,$q){var cnRecordView=cnRecordViewDirective[0];var reqnModel=CnReqnModelFactory.instance();return{templateUrl:module.getFileUrl("view.tpl.html"),restrict:"E",scope:{model:"=?"},link:function(scope,element,attrs){cnRecordView.link(scope,element,attrs);scope.isAddingProduction=false;scope.isDeletingProduction=[];scope.liteModel.viewModel.onView();scope.model.viewModel.afterView(function(){CnSession.setBreadcrumbTrail([{title:reqnModel.module.name.plural.ucWords(),go:function(){reqnModel.transitionToListState()}},{title:scope.model.viewModel.record.identifier,go:function(){reqnModel.transitionToViewState({getIdentifier:function(){return"identifier="+scope.model.viewModel.record.identifier}})}},{title:scope.model.module.name.singular.ucWords(),go:function(){scope.model.transitionToViewState(scope.model.viewModel.record)}}])})},controller:function($scope){if(angular.isUndefined($scope.model))$scope.model=CnFinalReportModelFactory.root;if(angular.isUndefined($scope.liteModel))$scope.liteModel=CnFinalReportModelFactory.lite;cnRecordView.controller[1]($scope);$scope.t=function(value){return CnReqnHelper.translate("finalReport",value,$scope.model.viewModel.record.lang)};var productionAddModel=$scope.model.viewModel.productionModel.addModel;$scope.productionRecord={};productionAddModel.onNew($scope.productionRecord);$scope.getHeading=function(){var status=null;if("deferred"==$scope.model.viewModel.record.state){status=$scope.model.isRole("applicant")?"Action Required":"Deferred to Applicant"}else if($scope.model.viewModel.record.state){status=$scope.model.viewModel.record.state.ucWords()}return[$scope.t("heading"),"-",$scope.model.viewModel.record.identifier,"version",$scope.model.viewModel.record.amendment_version,null!=status?"("+status+")":""].join(" ")};$scope.compareTo=function(version){$scope.model.viewModel.compareRecord=version;$scope.liteModel.viewModel.compareRecord=version;$scope.model.setQueryParameter("c",null==version?undefined:version.amendment_version);$scope.model.reloadState(false,false,"replace")};$scope.addProduction=function(){if($scope.model.viewModel.productionModel.getAddEnabled()){var form=cenozo.getScopeByQuerySelector("#part2Form").part2Form;var valid=true;for(var property in $scope.model.viewModel.productionModel.module.inputGroupList[0].inputList){var currentElement=cenozo.getFormElement(property);if(currentElement){currentElement.$error.conflict=false;cenozo.updateFormElement(currentElement);if(currentElement.$invalid){valid=false;break}}}if(!valid){cenozo.forEachFormElement("part2Form",function(element){element.$dirty=true})}else{$scope.isAddingProduction=true;productionAddModel.onAdd($scope.productionRecord).then(function(response){form.$setPristine();return $q.all([productionAddModel.onNew($scope.productionRecord),$scope.model.viewModel.getProductionList()])}).finally(function(){$scope.isAddingProduction=false})}}};$scope.removeProduction=function(id){if($scope.model.viewModel.productionModel.getDeleteEnabled()){if(!$scope.isDeletingProduction.includes(id))$scope.isDeletingProduction.push(id);var index=$scope.isDeletingProduction.indexOf(id);$scope.model.viewModel.removeProduction(id).finally(function(){if(0<=index)$scope.isDeletingProduction.splice(index,1)})}};$scope.check=function(property){var element=cenozo.getFormElement(property);if(element){element.$error.format=!$scope.model.viewModel.productionModel.testFormat(property,$scope.productionRecord[property]);cenozo.updateFormElement(element,true)}}}}}]);cenozo.providers.factory("CnFinalReportListFactory",["CnBaseListFactory",function(CnBaseListFactory){var object=function(parentModel){CnBaseListFactory.construct(this,parentModel)};return{instance:function(parentModel){return new object(parentModel)}}}]);cenozo.providers.factory("CnFinalReportViewFactory",["CnBaseViewFactory","CnReqnHelper","CnHttpFactory","CnProductionModelFactory","CnModalMessageFactory","CnModalConfirmFactory","CnModalSubmitExternalFactory","CnSession","$q",function(CnBaseViewFactory,CnReqnHelper,CnHttpFactory,CnProductionModelFactory,CnModalMessageFactory,CnModalConfirmFactory,CnModalSubmitExternalFactory,CnSession,$q){var object=function(parentModel,root){var self=this;CnBaseViewFactory.construct(this,parentModel,root);angular.extend(this,{compareRecord:null,versionList:[],translate:function(value){return CnReqnHelper.translate("finalReport",value,this.record.lang)},show:function(subject){return CnReqnHelper.showAction(subject,this.record)},viewReqn:function(){return this.parentModel.transitionToParentViewState("reqn","identifier="+this.record.identifier)},viewReqnVersion:function(){return this.parentModel.transitionToParentViewState("reqn_version",this.record.current_reqn_version_id)},onView:function(force){this.setFormTab(this.parentModel.getQueryParameter("t"),false);this.compareRecord=null;return this.$$onView(force).then(function(){if("lite"!=self.parentModel.type){cenozoApp.setLang(self.record.lang);return $q.all([self.getProductionList(),self.getProductionTypeList()]).then(function(){return self.getVersionList()})}})},onPatch:function(data){var property=Object.keys(data)[0];if(!this.parentModel.getEditEnabled())throw new Error("Calling onPatch() but edit is not enabled.");if(null==property.match(/^deferral_note/)){return self.$$onPatch(data)}else{var parent=this.parentModel.getParentIdentifier();var httpObj={path:parent.subject+"/"+parent.identifier,data:data};httpObj.onError=function(response){self.onPatchError(response)};return CnHttpFactory.instance(httpObj).patch().then(function(){self.afterPatchFunctions.forEach(function(fn){fn()})})}},toggleLanguage:function(){this.record.lang="en"==this.record.lang?"fr":"en";return CnHttpFactory.instance({path:"reqn/identifier="+this.record.identifier,data:{language:this.record.lang}}).patch()},productionModel:CnProductionModelFactory.instance(),productionList:[],productionTypeList:{},formTab:"",tabSectionList:["instructions","part1","part2","part3"],setFormTab:function(tab,transition){if(angular.isUndefined(transition))transition=true;var selectedTabSection=null;this.tabSectionList.some(function(tabSection){if(tab==tabSection){selectedTabSection=tabSection;return true}});tab=null!=selectedTabSection?selectedTabSection:"instructions";this.formTab=tab;this.parentModel.setQueryParameter("t",tab);if(transition)this.parentModel.reloadState(false,false,"replace");angular.element("textarea[cn-elastic]").trigger("elastic")},nextSection:function(reverse){if(angular.isUndefined(reverse))reverse=false;var currentTabSectionIndex=this.tabSectionList.indexOf(this.formTab);if(null!=currentTabSectionIndex){var tabSection=this.tabSectionList[currentTabSectionIndex+(reverse?-1:1)];if(angular.isDefined(tabSection))this.setFormTab(tabSection)}},getProductionList:function(finalReportId,object){var basePath=angular.isDefined(finalReportId)?"final_report/"+finalReportId:this.parentModel.getServiceResourcePath();if(angular.isUndefined(object))object=self.record;return CnHttpFactory.instance({path:basePath+"/production",data:{select:{column:["id","detail",{table:"production_type",column:"rank"},{table:"production_type",column:"name_en"},{table:"production_type",column:"name_fr"}]},modifier:{limit:1e3}}}).query().then(function(response){object.productionList=response.data})},getProductionTypeList:function(){this.productionTypeList={en:[{value:"",name:CnReqnHelper.translate("finalReport","misc.choose","en")}],fr:[{value:"",name:CnReqnHelper.translate("finalReport","misc.choose","fr")}]};return CnHttpFactory.instance({path:"production_type",data:{select:{column:["id","rank","name_en","name_fr","note_en","note_fr"]},modifier:{order:"rank",limit:1e6}}}).query().then(function(response){response.data.forEach(function(item){self.productionTypeList.en.push({value:item.id,name:item.name_en,note:item.note_en});self.productionTypeList.fr.push({value:item.id,name:item.name_fr,note:item.note_fr})})})},getProductionTypeNote:function(productionTypeId){var productionTypeList=this.productionTypeList[this.record.lang];var productionType=productionTypeList?productionTypeList.findByProperty("value",productionTypeId):null;return null==productionType?"":productionType.note},removeProduction:function(id){return CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath()+"/production/"+id}).delete().then(function(){return self.getProductionList()})},determineProductionDiffs:function(){this.versionList.forEach(version=>self.setProductionDiff(version))},setProductionDiff:function(version){if(null!=version){version.productionDiff=version.productionList.length!=self.record.productionList.length||version.productionList.some(c1=>!self.record.productionList.some(c2=>!["rank","production"].some(prop=>c1[prop]!=c2[prop])))}},getDifferences:function(finalReport2){var finalReport1=this.record;var differences={diff:false,part1:{diff:false,activities:false,findings:false,outcomes:false,thesis_title:false,thesis_status:false},part2:{diff:false,productionList:[]},part3:{diff:false,impact:false,opportunities:false,dissemination:false}};if(null!=finalReport2){for(var part in differences){if(!differences.hasOwnProperty(part))continue;if("diff"==part)continue;for(var property in differences[part]){if(!differences[part].hasOwnProperty(property))continue;if(angular.isArray(differences[part][property])){if("productionList"==property){finalReport1.productionList.forEach(function(p1){var p2=finalReport2.productionList.findByProperty("detail",p1.detail);if(null==p2){differences.diff=true;differences[part].diff=true;differences[part][property].push({name:p1.detail,diff:"added"})}});finalReport2.productionList.forEach(function(p2){var p1=finalReport1.productionList.findByProperty("detail",p2.detail);if(null==p1){differences.diff=true;differences[part].diff=true;differences[part][property].push({name:p2.detail,diff:"removed"})}})}}else{var value1=""===finalReport1[property]?null:finalReport1[property];var value2=""===finalReport2[property]?null:finalReport2[property];if(value1!=value2){differences.diff=true;differences[part].diff=true;differences[part][property]=true}}}}}return differences},getVersionList:function(){var parent=self.parentModel.getParentIdentifier();this.versionList=[];return CnHttpFactory.instance({path:parent.subject+"/"+parent.identifier+"/final_report"}).query().then(function(response){var promiseList=[];response.data.forEach(function(version){promiseList=promiseList.concat([self.getProductionList(version.id,version).then(function(){self.setProductionDiff(version)})]);self.versionList.push(version)});if(1<self.versionList.length){self.versionList.unshift(null)}return $q.all(promiseList).then(function(){self.versionList.reverse();self.lastAgreementVersion=null;self.versionList.forEach(function(version){if(null!=version)version.differences=self.getDifferences(version)});if(null==self.agreementDifferenceList)self.agreementDifferenceList=[];self.versionList.reverse()})})},submit:function(){function submitFinalReport(){var parent=self.parentModel.getParentIdentifier();return CnHttpFactory.instance({path:parent.subject+"/"+parent.identifier+"?action=submit"}).patch().then(function(){var code=CnSession.user.id==self.record.trainee_user_id?"deferred"==self.record.state?"traineeResubmit":"traineeSubmit":"deferred"==self.record.state?"resubmit":"submit";return CnModalMessageFactory.instance({title:self.translate("misc."+code+"Title"),message:self.translate("misc."+code+"Message"),closeText:"applicant"==CnSession.role.name?self.translate("misc.close"):"Close"}).show().then(function(){return self.parentModel.isRole("applicant")?$state.go("root.home"):self.onView(true)})})}var record=this.record;return this.record.external?CnModalSubmitExternalFactory.instance().show().then(function(response){if(null!=response){var parent=self.parentModel.getParentIdentifier();return CnHttpFactory.instance({path:parent.subject+"/"+parent.identifier+"?action=next_stage&stage_type="+response}).patch().then(function(){self.onView();return CnModalMessageFactory.instance({title:'Requisition moved to "'+response+'" stage',message:'The external requisition has been moved to the "'+response+'" stage.',closeText:"Close"}).show().then(function(){return self.onView(true)})})}}):CnModalConfirmFactory.instance({title:this.translate("misc.pleaseConfirm"),noText:"applicant"==CnSession.role.name?this.translate("misc.no"):"No",yesText:"applicant"==CnSession.role.name?this.translate("misc.yes"):"Yes",message:this.translate("misc.submitWarning")}).show().then(function(response){if(response){var requiredTabList={part1:["activities","findings","outcomes","thesis_title","thesis_status"],part3:["impact","opportunities","dissemination"]};var error=null;var errorTab=null;for(var tab in requiredTabList){var firstProperty=null;requiredTabList[tab].filter(function(property){if("part1"==tab){return null==property.match(/thesis/)||self.record.trainee_user_id}return true}).forEach(function(property){if(null===record[property]||""===record[property]){var element=cenozo.getFormElement(property);element.$error.required=true;cenozo.updateFormElement(element,true);if(null==errorTab)errorTab=tab;if(null==error)error={title:self.translate("misc.missingFieldTitle"),message:self.translate("misc.missingFieldMessage"),error:true}}})}if(null!=error){if("applicant"==CnSession.role.name)error.closeText=self.translate("misc.close");CnModalMessageFactory.instance(error).show().then(function(){self.setFormTab(errorTab)})}else{return CnHttpFactory.instance({path:self.parentModel.getServiceResourcePath(),data:{select:{column:"has_changed"}}}).get().then(function(response){return response.data.has_changed?submitFinalReport():CnModalConfirmFactory.instance({title:self.translate("misc.pleaseConfirm"),noText:"applicant"==CnSession.role.name?self.translate("misc.no"):"No",yesText:"applicant"==CnSession.role.name?self.translate("misc.yes"):"Yes",message:self.translate("misc.noChangesMessage")}).show().then(function(response){if(response)return submitFinalReport()})})}}})}});this.productionModel.metadata.getPromise()};return{instance:function(parentModel,root){return new object(parentModel,root)}}}]);cenozo.providers.factory("CnFinalReportModelFactory",["CnBaseModelFactory","CnFinalReportListFactory","CnFinalReportViewFactory","CnSession","$state",function(CnBaseModelFactory,CnFinalReportListFactory,CnFinalReportViewFactory,CnSession,$state){var object=function(type){var self=this;CnBaseModelFactory.construct(this,module);angular.extend(this,{viewModel:CnFinalReportViewFactory.instance(this,"root"==this.type),inputList:{},setupBreadcrumbTrail:function(){var trail=[];if(this.isRole("applicant")){trail=[{title:"Requisition"},{title:this.viewModel.record.identifier}]}else{trail=[{title:"Requisitions",go:function(){return $state.go("reqn.list")}},{title:this.viewModel.record.identifier,go:function(){return $state.go("reqn.view",{identifier:"identifier="+self.viewModel.record.identifier})}},{title:"Final Report version "+this.viewModel.record.version}]}CnSession.setBreadcrumbTrail(trail)}});if("lite"!=this.type)this.listModel=CnFinalReportListFactory.instance(this);module.inputGroupList.forEach(group=>Object.assign(self.inputList,group.inputList))};return{root:new object("root"),lite:new object("lite"),instance:function(){return new object(false)}}}])});
